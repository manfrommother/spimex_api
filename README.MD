# SPIMEX Trading API

Микросервисное приложение для предоставления данных о торгах СПИМЕКС (Санкт-Петербургская Международная Товарно-сырьевая Биржа) в формате JSON.

## Функциональность

Приложение предоставляет следующие API-эндпоинты:

1. **Получение списка последних торговых дат** - `/api/trading/dates`
   - Возвращает список дат последних торговых дней с возможностью ограничения количества записей

2. **Получение данных о торгах за указанный период** - `/api/trading/dynamics`
   - Возвращает список результатов торгов за указанный период с возможностью фильтрации по различным параметрам

3. **Получение последних результатов торгов** - `/api/trading/results`
   - Возвращает список последних результатов торгов с возможностью фильтрации и ограничения количества записей

## Технологии

- **FastAPI** - высокопроизводительный фреймворк для создания API
- **SQLAlchemy** - ORM для работы с базой данных
- **PostgreSQL** - СУБД для хранения данных
- **Redis** - система кеширования с автоматическим сбросом в 14:11
- **Docker** - контейнеризация приложения
- **Docker Compose** - управление многоконтейнерными приложениями

## Требования

- Python 3.8+
- PostgreSQL 12+
- Redis 6+

## Установка и запуск

### Локальное окружение

1. Клонируйте репозиторий:
```bash
git clone https://github.com/your-username/spimex-trading-api.git
cd spimex-trading-api
```

2. Создайте и активируйте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate     # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл `.env` с настройками:
```
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=12345678
DB_NAME=spimex
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
DEBUG=True
```

5. Запустите приложение:
```bash
uvicorn main:app --reload
```

## Использование API

После запуска приложения документация API будет доступна по адресу `http://localhost:8000/docs`.

### Примеры запросов

#### Получение списка последних торговых дат
```http
GET /api/trading/dates?limit=5
```

#### Получение данных о торгах за указанный период
```http
GET /api/trading/dynamics?start_date=2024-01-01&end_date=2024-01-31&oil_id=1
```

#### Получение последних результатов торгов
```http
GET /api/trading/results?oil_id=1&limit=50
```

## Параметры API

### GET /api/trading/dates
- `limit` (по умолчанию: 10, опционально) - Ограничение количества последних дат
  - **Обоснование**: Параметр опциональный, так как клиент может запросить все даты или указать конкретное количество. По умолчанию установлено разумное ограничение.

### GET /api/trading/dynamics
- `start_date` (обязательный) - Начальная дата периода
- `end_date` (обязательный) - Конечная дата периода
  - **Обоснование**: Параметры обязательные, так как запрос по периоду невозможен без указания временных границ.
- `oil_id` (опционально) - ID типа нефтепродукта
- `delivery_type_id` (опционально) - ID типа поставки
- `delivery_basis_id` (опционально) - ID базиса поставки
  - **Обоснование**: Параметры фильтрации опциональные, чтобы дать возможность клиенту получить как все данные за период, так и применить различные фильтры.

### GET /api/trading/results
- `oil_id` (опционально) - ID типа нефтепродукта
- `delivery_type_id` (опционально) - ID типа поставки
- `delivery_basis_id` (опционально) - ID базиса поставки
  - **Обоснование**: Параметры фильтрации опциональные, чтобы дать возможность клиенту получить как все данные, так и применить различные фильтры.
- `limit` (по умолчанию: 100, опционально) - Ограничение количества записей
  - **Обоснование**: Параметр опциональный с разумным ограничением по умолчанию, чтобы предотвратить слишком большие запросы, но дать возможность клиенту получить нужное количество записей.

## Система кеширования

Приложение использует Redis для кеширования результатов запросов до 14:11 следующего дня. После этого времени происходит автоматический сброс кеша.

### Принцип работы кеширования:

1. Для каждого запроса создается уникальный ключ на основе параметров запроса
2. При запросе сначала проверяется наличие данных в кеше
3. Если данные найдены в кеше, они возвращаются клиенту без обращения к БД
4. Если данных нет в кеше, они запрашиваются из БД, затем сохраняются в кеше с TTL до 14:11
5. В 14:11 каждого дня происходит автоматический сброс всего кеша




## Разработка и расширение

### Добавление новых эндпоинтов

1. Создайте новый метод в сервисном слое (`app/services/trading.py`)
2. Добавьте соответствующие модели ответов в `app/models/response.py`
3. Создайте новый обработчик маршрута в `main.py`

### Изменение системы кеширования

Настройки кеширования можно изменить в файле `.env` или в переменных окружения:

- `CACHE_RESET_HOUR` - час сброса кеша
- `CACHE_RESET_MINUTE` - минута сброса кеша
